<!DOCTYPE html>
<html lang="zh-Hant-TW">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AJAX example</title>

    <!-- import CSS 
    <link rel="stylesheet" href="js/jquery-ui.min.css">
    <style>
    </style>
	<script src="js/vue.global.prod.js"></script>

-->
	<script>
    // let 是javascript 用來宣告local變數，只活在{}範圍內
    // const 常數，宣告就不能再改
    // var 放在function裡面就是活在function中，如果放在外面就是global變數
	function loadList() { //打算要去抓的網址、要放到哪一個div
		fetch("todoControlAjex.php?act=getList" ) //發request，需要一段時間，會回傳出promise物件
		.then(function(resp){ //要等fetch執行完，才會callback這個then，
            // console.log(resp)          
		    return resp.json(); //把promise物件變成字串
		}) // .的意思是把上一個回傳值，變成下一個輸入值 
		.then(function(json) { //.then要等，等web端callback，也可以是上一個callback做完，往下一個callback走
			if (json){ //當json不是空值
				let tableStr = "<table>";
                for(let row of json){ //把json的內容變成html的表格元件
                    tableStr += "<tr><td>" + row['title'];
                    tableStr += "</td><td>" + row['note'];
                    tableStr += "</td><td><button onclick='setJobDone(" + row['id'] + ")'>已完成</button></td></tr>"; //在表格裡頭加上已完成按鈕
                }
                tableStr += "</table>";
                document.getElementById("main").innerHTML = tableStr; //把html放到main這個div裡面
			}
		})
	}
    function setJobDone(id){ //已完成按鈕按下後，要將完成時間更新
        fetch("todoControlAjex.php?act=setFinish&id=" + id) //發request，需要一段時間，會回傳出promise物件
		.then(function(resp){ //要等fetch執行完，才會callback這個then，
		    return resp.text(); //把promise物件變成字串
		}) // .的意思是把上一個回傳值，變成下一個輸入值 
		.then(function(rr) { //.then要等，等web端callback，也可以是上一個callback做完，往下一個callback走
			if (rr){ //當tesxt不是空值
				console.log(rr);
                loadList(); //因為已經加入已完成時間，所以重新整理清單畫面
			}
		})
    }
	function postData(url,keyword) {
		let mydat = new FormData(); //這是一個表單物件
		
		mydat.append( "f",keyword); //表單物件中append一個新的欄位叫f，並把傳進來的值填入該欄，所以等等3.php就會去找這個f
		fetch(url,{
			method: 'POST', // or 'GET', 'PUT'
			body: mydat //用mydat模擬成好像是網頁的表單
			//body: JSON.stringify(data)
		})
		//.then(function(resp){return resp.text();})		
		.then(
			function(res) {
				//console.log(res)
				return res.json(); //因為這邊傳回來的值會是json字串，所以要轉成javascript的json物件
			}
		)
		.then(
			function(data) {
                //console.log(data[0]['a']);
                //console.log(data[3]['b']);
				//console.log(data)
				json2table(data,'main'); //這個函數的用意是把json物件轉成html的table
			}
		)
	}
	//表單的submit會跑到下一頁去，所以如果希望留在原本的頁面
	function postForm(url,formID) { //我要post出去的url，表單給他個ID:formid
		let mydat = new FormData(); //宣告一個區域變數，型態是formdata
		myform = document.getElementById(formID);//從myform這個表單物件裡面，把它當成FormData這個物件的來源，所以依照myform的內容，產生一個formdata的物件
        //用for迴圈將，pair代表表單裡的每一個欄位
        for (const pair of new FormData(myform)) { //依照裡面的內容，產生一個formdata的物件
			mydat.append(pair[0], pair[1]); //把你要的欄位塞進去表單物件
		}
		fetch(url,{
			method: 'POST',
			body: mydat //放在body當表單內容
		})
		//.then(function(resp){return resp.text();})		
		.then(
			function(res) {
				//console.log(res)
				return res.json();
			}
		)
		.then(
			function(data) {
				//console.log(data)
				json2table(data,'main'); //把資料傳入此function，之後放到div(main頁面)
			}
		)
	}

	
	function json2table(json,divID) {
		// Get keys (=cells) of each items
		const keys = Object.keys(json[0]); //json物件裏頭的第0筆資料，把裡面的鍵值全部抓出來，放到這個變數keys
        //const是常數，以後不變

		// Build the table header
		const header = `<thead><tr>` +  //反斜線:表示之後會把反斜線裏頭的內容變成網頁元件
		keys.map(key => `<th>${key}</th>`) // map: 將陣列裏頭的每一個key值當變數傳入{key}，組成一個新的templete(模板，<th>${key}</th>)
		  .join('') + `</thead></tr>`; //將個別陣列join(接)起來變成一個字串，在跟前後html串起來，這就是表頭(header)
  
		// Build the table body
		const body = `<tbody>` +
		  json.map(row => `<tr>${Object.values(row)
			.map(cell => `<td>${cell}</td>`)
			.join('')}</tr>`
		  ).join('');

		// Build the final table
		const table = ` //將製作好的表頭跟表身加上html的table，變成一個table的物件
		<table border = '1'>
		  ${header}
		  ${body}
		</table>
		`;
  
		// Append the result into #root element
		document.getElementById(divID).innerHTML = table;
	}

	function loadJSON() {
		let keyw=document.getElementById('myurl').value; //打一個關鍵字
		postData("3.php", keyw);//叫server端幫我過濾
	}
	</script>
  </head>
  <body> <!--網頁的主要頁面-->
  <button onclick="loadList()">列出代辦事項</button> 
  <button onclick = "loadAddForm()">新增工作</button>
<!-- main working div-->
<div id="main">hello</div> <!--這裡是一個網頁元件 -->
</body>
</html>
